<script>
    const { createApp, ref, watch, onMounted } = Vue;

    // 1. 这里是全局默认提示词
    const defaultGlobalPrompt = (drinkName) => `A professional photography of ${drinkName} cocktail, high contrast, bright drink, dimly lit luxurious bar background, dramatic lighting, bokeh effect, no people, no hands, ultra-realistic, 8k, cinematic, warm tones`;

    // 2. 这里是数据源，您可以在这里直接修改 aiPrompt
    const defaultClassic = [
        { 
            id: 1, 
            name: 'PALERMO', 
            subName: '巴勒莫', 
            price: '36', 
            tags: '苦酒 / 热带果香', 
            desc: '意式苦酒与热带果香的西西里邂逅。', 
            seed: 101, 
            longDesc: "Palermo 是对经典 Campari-Soda 的一次热带升级...", 
            // ▼▼▼ 在这里直接写提示词 (必须用英文) ▼▼▼
            aiPrompt: '' 
        },
        { id: 2, name: 'Mamie Taylor', subName: '玛米泰勒', price: '36', tags: '姜 / 威士忌 / 青柠', desc: '19世纪的经典，复古组合。', seed: 102, longDesc: "...", aiPrompt: '' },
        { id: 3, name: 'El Diablo', subName: '恶魔', price: '38', tags: '莓果 / 姜 / 辛辣', desc: '龙舌兰与黑醋栗的完美风暴。', seed: 103, longDesc: "...", aiPrompt: '' },
        // ... 您的 Zombie 示例
        { 
            id: 4, 
            name: 'Zombie', 
            subName: '僵尸', 
            price: '38', 
            tags: '朗姆 / 热带 / 强劲', 
            desc: '极其危险的诱惑。', 
            seed: 104, 
            longDesc: "...", 
            // ▼▼▼ 已经写好的示例 ▼▼▼
            aiPrompt: 'Zombie cocktail in a tiki glass, tropical bar background, dramatic lighting, bright drink, no people, 8k' 
        },
        { id: 5, name: 'Long Island', subName: '长岛冰茶', price: '45', tags: '五种基酒 / 烈性', desc: '无害外表下的烈性。', seed: 105, longDesc: "...", aiPrompt: '' }
    ];

    const defaultNew = [
        { 
            id: 6, 
            name: 'Aperol Spritz', 
            subName: '阿佩罗橙光', 
            price: '38', 
            tags: '橙香 / 气泡', 
            desc: '明亮的橙色伴随着清爽气泡。', 
            seed: 201, 
            longDesc: "...", 
            // ▼▼▼ 已经写好的示例 ▼▼▼
            aiPrompt: 'Aperol Spritz cocktail in a large wine glass, summer terrace background, natural light, bright orange liquid, no people, 8k' 
        },
        { id: 7, name: 'Paper Plane', subName: '纸飞机', price: '40', tags: '柑橘 / 草本', desc: '纽约现代经典，精致平衡。', seed: 202, longDesc: "...", aiPrompt: '' },
        { id: 8, name: 'Acapulco', subName: '阿卡普尔科', price: '38', tags: '菠萝 / 西柚', desc: '源自墨西哥海岸的变体长饮。', seed: 203, longDesc: "...", aiPrompt: '' },
        { id: 9, name: 'White Lady', subName: '白色佳人', price: '33', tags: '柑橘 / 花香', desc: '优雅的短饮。', seed: 204, longDesc: "...", aiPrompt: '' },
        { id: 10, name: 'Negroni', subName: '尼格罗尼', price: '42', tags: '苦甜 / 经典', desc: '平衡的苦甜交响曲。', seed: 205, longDesc: "...", aiPrompt: '' }
    ];

    createApp({
        setup() {
            const classicDrinks = ref([]);
            const newDrinks = ref([]);
            const isModalOpen = ref(false);
            const selectedDrink = ref({});

            const initData = () => {
                const savedClassic = localStorage.getItem('mm_classic');
                const savedNew = localStorage.getItem('mm_new');
                if (savedClassic && savedNew) {
                    // 深度合并逻辑，确保即使旧数据没有 aiPrompt 字段也能正常运行
                    const mergeData = (saved, defaults) => {
                        const parsed = JSON.parse(saved);
                        return parsed.map((item, index) => {
                            const defaultItem = defaults[index] || {};
                            return {
                                ...item,
                                longDesc: item.longDesc || item.desc,
                                // 如果本地缓存里没有 prompt，就优先用源代码里的 default 值，还没有才为空
                                aiPrompt: item.aiPrompt !== undefined ? item.aiPrompt : (defaultItem.aiPrompt || '')
                            };
                        });
                    };
                    classicDrinks.value = mergeData(savedClassic, defaultClassic);
                    newDrinks.value = mergeData(savedNew, defaultNew);
                } else {
                    resetData();
                }
            };

            const resetData = () => {
                classicDrinks.value = JSON.parse(JSON.stringify(defaultClassic));
                newDrinks.value = JSON.parse(JSON.stringify(defaultNew));
            };

            // ★★★ 核心修复：自动处理换行符和空格 ★★★
            const getAIImage = (drink) => {
                let rawPrompt = drink.aiPrompt && drink.aiPrompt.trim() !== '' 
                                    ? drink.aiPrompt 
                                    : defaultGlobalPrompt(drink.name);
                
                // 强制将换行符替换为空格，防止 URL 断裂
                const cleanPrompt = rawPrompt.replace(/[\r\n]+/g, ' ');

                return `https://image.pollinations.ai/prompt/${encodeURIComponent(cleanPrompt)}?width=600&height=600&nologo=true&model=flux&seed=${drink.seed}`;
            };

            const regenerateImage = (drink) => {
                drink.seed = Math.floor(Math.random() * 100000);
                if (isModalOpen.value && selectedDrink.value.id === drink.id) {
                    selectedDrink.value = { ...drink }; 
                }
            };

            const openModal = (drink) => {
                selectedDrink.value = drink;
                isModalOpen.value = true;
            };
            const closeModal = () => {
                isModalOpen.value = false;
                selectedDrink.value = {};
            };

            const addNewDrink = () => {
                const newId = Date.now();
                newDrinks.value.unshift({
                    id: newId,
                    name: 'New Cocktail',
                    subName: '新品',
                    price: '00',
                    tags: '风味',
                    desc: '点击编辑',
                    longDesc: '详细介绍...',
                    aiPrompt: '', 
                    seed: newId
                });
            };

            const deleteDrink = (type, index) => {
                if(!confirm('Delete?')) return;
                type === 'classic' ? classicDrinks.value.splice(index, 1) : newDrinks.value.splice(index, 1);
            };

            watch([classicDrinks, newDrinks], () => {
                localStorage.setItem('mm_classic', JSON.stringify(classicDrinks.value));
                localStorage.setItem('mm_new', JSON.stringify(newDrinks.value));
            }, { deep: true });

            onMounted(() => {
                initData();
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && isModalOpen.value) closeModal();
                });
            });

            return {
                classicDrinks, newDrinks, isModalOpen, selectedDrink,
                getAIImage, regenerateImage, openModal, closeModal,
                addNewDrink, deleteDrink, resetData
            };
        }
    }).mount('#app');
</script>
